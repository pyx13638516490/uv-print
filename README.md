# 多軸 DLP 3D 打印機控制系統

## 1. 專案概述

本專案是一個基於 PC 上位機和 ESP32 下位機的客製化四軸 DLP 3D 打印機的完整控制系統。系統通過 Wi-Fi 進行通訊，實現了對 Z、A、B、C 四個獨立軸的精確控制，並整合了對第三方光機控制軟體的自動化操作。

該系統採用半自動化工作流程，由 PC 腳本完成部分自動化設定，然後由用戶進行手動精調和確認，最後由腳本接管並執行全自動的逐層打印任務。

## 2. 核心功能

* **四軸獨立與聯動控制**:
    * **Z 軸**: 高精度閉環控制，負責打印平台的剝離和升降。
    * **A 軸**: 與 Z 軸聯動，實現「Z 軸下降 -> A 軸快速擦拭 -> Z 軸回升 -> A 軸慢速歸位」的複雜層間動作。
    * **B 軸**: 液位自動補償軸，與激光位移傳感器聯動，實時維持樹脂液面高度。
    * **C 軸**: 光機手動定位軸，可在打印開始前通過終端指令進行手動微調。
* **高階硬體支持**: 支持雷賽 (Leadshine) 閉環步進驅動器、DM542 等工業級驅動器。
* **GUI 自動化**: 通過 `pywinauto` 自動化控制 `Full-HD UV LE Controller v2.1.exe` 軟體，實現曝光控制。
* **穩定的通訊**: 採用 Wi-Fi (TCP Socket) 在上位機 (PC) 和下位機 (ESP32) 之間進行通訊，避免了物理串口衝突。
* **靈活的工作流程**: 結合了自動化與手動控制，在打印開始前為用戶提供了靈活的調整空間。
* **智慧顯示**: 自動檢測第二螢幕（投影儀）並將打印圖像全螢幕投射，若無第二螢幕則在主螢幕以小視窗預覽，防止操作鎖定。
## 3. 硬體需求

| 組件 | 型號/規格 | 數量 | 用途 |
| :--- | :--- | :--- | :--- |
| **上位機** | 運行 Windows 的 PC | 1 | 總控制、圖像顯示 |
| **下位機** | ESP32-WROOM-32 開發板 | 1 | 運動控制、傳感器讀取 |
| **光固化光機** | NVM PLUS UV ENGINE | 1 | 曝光成像 |
| **Z 軸電機** | [cite_start]雷賽 57CM23-BZ (閉環) [cite: 906, 907, 908, 909, 910, 911, 912, 913, 914, 915, 916, 917, 918, 919, 920, 921, 922, 923, 924, 925, 926, 927] | 1 | 平台升降 |
| **Z 軸驅動器** | [cite_start]雷賽 CL1-507 (閉環) [cite: 906, 907, 908, 909, 910, 911, 912, 913, 914, 915, 916, 917, 918, 919, 920, 921, 922, 923, 924, 925, 926, 927] | 1 | 驅動 Z 軸電機 |
| **A/C 軸電機** | NEMA 23 (57) 步進電機 | 2 | 擦拭/光機定位 |
| **A/C 軸驅動器** | [cite_start]DM542 [cite: 795, 796, 797, 798] | 2 | 驅動 A/C 軸電機 |
| **B 軸電機** | NEMA 17 或更小的步進電機 | 1 | 液位補償 |
| **B 軸驅動器** | A4988 | 1 | 驅動 B 軸電機 |
| **液位傳感器**| [cite_start]松下 HGC-1030 (類比輸出型) [cite: 1269, 1270, 1271, 1272] | 1 | 檢測樹脂液面 |
| **電機電源** | 24V-48V DC 直流電源 | 1+ | 為 CL1-507 和 DM542 供電 |
| **邏輯電源** | 5V DC (用於 A4988) | 1 | 為 A4988 邏輯部分供電 |
| **分壓電阻** | 2.2kΩ 和 3.3kΩ | 各 1 | 保護 ESP32 的 ADC 引腳 |

## 4. 軟體與依賴

### 4.1 電腦端 (PC)

* **IDE**: PyCharm (推薦)
* **Python**: Python 3.8+
* **必要的函式庫**: 請在 PyCharm 的終端中，使用國內鏡像源一次性安裝所有依賴：
    ```bash
    pip install -i [https://pypi.tuna.tsinghua.edu.cn/simple](https://pypi.tuna.tsinghua.edu.cn/simple) Pillow pywinauto pyserial screeninfo
    ```
* **控制腳本**: `main_controller.py`
* **光機軟體**: `Full-HD UV LE Controller v2.1.exe`
* **切片文件**: `layers.zip`

### 4.2 ESP32 端

* **固件**: MicroPython v1.19.1 或更新的通用 (Generic) 版本。
* **IDE**: Thonny (推薦)
* **啟動腳本**: `boot.py` (負責連接 Wi-Fi)
* **主程式腳本**: `main.py` (負責運動控制)

## 5. 系統設定與配置

### 5.1 硬體設定

1.  **電機驅動器 DIP 開關**：
    * [cite_start]**Z 軸 (CL1-507)**: 根據 `CL1-507...说明书.pdf` [cite: 906, 907, 908, 909, 910, 911, 912, 913, 914, 915, 916, 917, 918, 919, 920, 921, 922, 923, 924, 925, 926, 927] 設定**細分 (每轉脈衝數)**。
    * [cite_start]**A/C 軸 (DM542)**: 根據 `DM542 驱动器说明书.pdf` [cite: 795, 796, 797, 798] 設定**細分**和**運行電流**。
    * **B 軸 (A4988)**: 確保 `MS1`, `MS2`, `MS3` 引腳已通過跳線帽連接，以啟用 1/16 細分。

2.  **接線**：請嚴格按照我們之前討論確定的最終接線圖進行連接，特別注意**共地**和 HGC-1030 傳感器的**分壓電路**。

### 5.2 軟體配置

1.  **ESP32 - `boot.py`**:
    * 打開 `boot.py` 文件，將 `YOUR_WIFI_SSID` 和 `YOUR_WIFI_PASSWORD` 修改為您自己的 Wi-Fi 名稱和密碼。

2.  **PC - `main_controller.py`**:
    * 打開 `main_controller.py` 文件，仔細檢查頂部的 `PrintConfig` 類別。
    * 修改 `ESP32_IP_ADDRESS` 為您的 ESP32 開機後獲取的實際 IP 地址。
    * 確保 `Z_PULSE_PER_REV`, `A_PULSE_PER_REV`, `C_PULSE_PER_REV` 的值與您在驅動器 DIP 開關上設定的**每轉脈衝數完全一致**。
    * 根據您的機械結構，檢查並修改 `Z_LEAD`, `A_LEAD`, `B_LEAD`, `C_LEAD` 的值。

## 6. 操作流程

1.  **啟動下位機**：為 ESP32 和所有電機驅動器通電。在 Thonny 中連接 ESP32，確認 `boot.py` 成功運行並打印出 Wi-Fi IP 地址。
2.  **啟動上位機**：在電腦上運行 `main_controller.py` 腳本。
3.  **手動控制 (C 軸)**：腳本會進入手動控制模式。您可以根據提示輸入 `c up [距離]` 或 `c down [距離]` 來微調 C 軸。
4.  **開始打印流程**：在 C 軸調整到位後，輸入 `print` 並按 `Enter`。
5.  **手動設定光機**：腳本會自動打開光機控制軟體 `Full-HD...exe`，然後暫停。請您手動完成軟體內的設定（Projector On -> 點擊彈窗 -> 選 HDMI -> 設電流）。
6.  **觸發自動打印**：在光機軟體設定好後，回到 PyCharm 終端，輸入 `ok` (或 `print`，根據最新腳本的提示) 並按 `Enter`。
7.  **自動打印**：腳本將接管一切，自動創建投影視窗並開始逐層曝光和打印。
8.  **打印結束**：打印完成後，Z 軸會自動回位並抬升 2mm，方便取件。您可以手動關閉所有軟體和電源。